<div [@fadeIn]="getEtat()">
    <img draggable="false" class="retour" [hidden]="data.lieuActuel.parent==''" src="./assets/images/retour.png"
        (click)="clickRetour()" (mouseover)="focus=undefined" style="z-index:2;" />
    <img *ngIf="data.repos.animation" draggable="false" class="map" src="./assets/images/maps/repos.gif"
        id="map" style="z-index:10;"/>
    <img *ngIf="oiseaux&&data.lieuActuel.oiseaux" draggable="false" class="map haut" src="./assets/images/maps/oiseaux.gif"
    id="map" style="position:absolute;z-index:10;height:200px;top:30%;left:0;right:0;transform: translate(0,-50%);"/>
    <div class="fond_eau"></div>
    <img draggable="false" class="map" src="./assets/images/maps/{{data.lieuActuel.image}}.png"
        (click)="clicMap($event)" (contextmenu)="clicDroitMap($event)" id="map"
        [style.border]="data.admin?'20px ridge #dd2020':'20px ridge #202020'" style="z-index:1;"/>

    <!-- ========================== LIEUX ========================== -->

    <div *ngFor="let lieu of getLieux()" class="lieux" [style.left]="lieu.x+'px'" [style.top]="lieu.y+'px'"
        [style.width]="lieu.finx+'px'" [style.height]="lieu.finy+'px'" (click)="rentrerLieu(lieu)"
        [cdkDragDisabled]="!data.admin" (cdkDragEnded)="endDragLieu($event,lieu)" cdkDrag style="z-index:2;">

        <!--(cdkDragEnded)="dragEnd($event,lieu)" 
        cdkDrag>-->

        <p class="nomLieu" (mouseover)="focus=undefined">{{lieu.nom}}</p>

        <div class="personnagesInside">
            <div *ngFor="let perso of getJoueursDansLieu(lieu)">
                <app-icone-personnage [perso]="perso" (mouseover)="focus=perso" (click)="sortirPerso(lieu,perso)">
                </app-icone-personnage>
            </div>
        </div>

        <!-- ========================== FENETRE DE CHANGEMENT DE LIEU ========================== -->

        <div class="changeLieu fenetre" *ngIf="changingTo==lieu&&(lieu.canEnter==undefined||lieu.canEnter)">
            <p class="bigText">Qui rentre dans {{changingTo.nom}} ?</p>
            <div class="line"></div>
            <div class="flexCenter">
                <div>
                    <app-icone-personnage *ngFor="let perso of getEntitesPresentes(0)" [perso]="perso"
                        (mouseover)="focus=perso" (click)="rentrerEntite(lieu,perso)"
                        (mouseover)="persoHovered[0]=perso.nom + ' - ' + perso.pdv + '/'+perso.pdvmax"
                        (mouseout)="persoHovered[0]=''"></app-icone-personnage>
                </div>
            </div>
            <p class="nomPerso">{{persoHovered[0]}}</p>
            <div class="flexCenter">
                <div>
                    <app-icone-personnage *ngFor="let perso of getEntitesPresentes(1)" [perso]="perso"
                        (mouseover)="focus=perso" (click)="rentrerEntite(lieu,perso)"
                        (mouseover)="persoHovered[1]=perso.nom + ' - ' + perso.pdv + '/'+perso.pdvmax"
                        (mouseout)="persoHovered[1]=''"></app-icone-personnage>
                </div>
            </div>
            <p class="nomPerso">{{persoHovered[1]}}</p>
            <div class="flexCenter">
                <div>
                    <app-icone-personnage *ngFor="let perso of getEntitesPresentes(2)" [perso]="perso"
                        (mouseover)="focus=perso" (click)="rentrerEntite(lieu,perso)"
                        (mouseover)="persoHovered[2]=perso.nom + ' - ' + perso.pdv + '/'+perso.pdvmax"
                        (mouseout)="persoHovered[2]=''"></app-icone-personnage>
                </div>
            </div>
            <p class="nomPerso">{{persoHovered[2]}}</p>
            <div class="line"></div>
            <p class="choix" (click)="changeLieu(lieu)">Entrer</p>
        </div>
    </div>

    <!-- ========================== PERSONNAGES ========================== -->

    <app-entites [data]="data" [mapHeight]="mapHeight" class="entites"></app-entites>

    <!-- ========================== MENU CONTEXTUEL ========================== -->

    <app-menu-contextuel class="menuContextuel" *ngIf="menuContextuel!=undefined" [menu]="menuContextuel" [data]="data"
        (addEntityEvent)="addEntity($event)">
    </app-menu-contextuel>

    
    <!-- ========================== TABLEAU DE QUETES ========================== -->

    <div *ngIf="data.lieuActuel.nom=='Panneau de Quêtes'" class="tableau_quetes">
        <div *ngFor="let quete of getQuetes()" class="quete"
            [style.left]="quete.tableauQuetes.x + 'px'"
            [style.top]="quete.tableauQuetes.y + 'px'"
            [style.z-index]="quete.tableauQuetes.zIndex"
            (cdkDragStarted)="dragStart(quete)"
            (cdkDragEnded)="endDragQuete($event,quete)"
            cdkDrag >
            <img src="./assets/images/{{quete.tableauQuetes.image}}.png"/>
            <img class="clou" src="./assets/images/clou_quete.png"/>
            <p (click)="voirQuete(quete)" class="nom_quete bigText clickable">{{quete.nom}}</p>
        </div>
        <div *ngIf="focusQuete!=undefined" class="voir_quete">
            <p class="croix clickable" (click)="close()">X</p>
            <img class="image_fond" src="./assets/images/{{focusQuete.tableauQuetes.image}}.png"/>
            <p class="titre_quete bigbigText">{{focusQuete.nom}}</p>
            <p class="description_quete bigText">{{focusQuete.etapeEnCours.description}}</p>
            <div *ngIf="focusQuete.recompenses" id="recompensePaiement">
                <p class="bigText">Récompense</p>
                <div class="flex wrap gap-1 recompensePaiement">
                    <div class="recompense flex align-center" *ngFor="let recompense of focusQuete.recompenses">
                        <img *ngIf="recompense.image" src="./assets/images/items/{{ recompense.image }}.png" />
                        <div class="flex column">
                            <p>{{recompense.nom}}</p>
                            <p>Qte: {{recompense.qte}}</p>
                        </div>
                    </div>
                    <div class="flex recompense golds align-center">
                        <p>{{focusQuete.paiement}}</p>
                        <img src="../../assets/images/pieces.png" />
                    </div>
                </div>
            </div>
        </div>
        <div *ngIf="focusQuete!=undefined" class="accept_quete">
            <p (click)="prendrePapier()" class="bigText clickable">Prendre le papier de quête</p>
            <p *ngIf="focusQuete.etatQuete == 0" (click)="accepQuete()" class="bigText clickable"
                (mouseleave)="queteAccepter = ''">
                {{queteAccepter == focusQuete.nom && queteAccepter != '' ? 'Confirmer vouloir accepter la quête ?' :
                'Accepter la quête !'}}
            </p>
            <p *ngIf="focusQuete.etatQuete == 1" class="bigText">La quête a été acceptée</p>
        </div>
    </div>
</div>